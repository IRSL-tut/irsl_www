<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Image and VirtualJoy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <style>
      html {
          height: 100%;
      }
      body {
          height: 100%;
          margin: 0;
      }
      .layout {
          width: 100%;
          height: 100%;
          display: grid;
          grid:
              "header" auto
              "main" auto
              "footer" 4fr;
          gap: 8px;
      }
      .header {
          grid-area: header;
          background: rgba(177, 177, 87, 0.1);
      }
      .main {
          grid-area: main;
          background: rgba(0, 0, 255, 0.1);
      }
      .footer {
          grid-area: footer;
          background: rgba(255, 0, 255, 0.1);
          position: relative;
      }
      .select{
          font-size: 20px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script src="../ros/rosmain.js"></script>
    <script>
      const ros = ros_start();
    </script>
    <script src="img.js"></script>
    <script>
      let joytopic = new ROSLIB.Topic({
          ros : ros,
          name : '/webjoy',
          messageType : 'sensor_msgs/Joy' // ROS1
      });
    </script>
</head>
<!-- https://qiita.com/shoichi4411/items/fcbe4b0fc2d98c72b55e -->
<body>
  <section class="layout" >
    <div class="header" id="header-contents"> </div>
    <div class="main" id="img-contents">
      <!-- pulldown -->
      <div class="select">Image:
      <select class="select" name="image-name" id="img-select" >
        <option value="base">base</option>
        <option value="arm" >arm</option>
        <option value="hand">hand</option>
      </select></div>
      <!-- H3><div class="image-name" >Base</div></H3 -->
      <img id="rosimg" src="" />
    </div>

    <div style="padding: 10px; background: rgba(255, 255, 255, 0.2);">
        <h3>関節スライダー</h3>
        <div><label>BASE_Y</label><input id="slider-base-y" type="range" min="-1" max="1" step="0.01" value="0"></div>
        <div><label>BASE_P</label><input id="slider-base-p" type="range" min="-1" max="1" step="0.01" value="0"></div>
        <div><label>BASE_R</label><input id="slider-base-r" type="range" min="-1" max="1" step="0.01" value="0"></div>
        <div><label>ELBOW_Y</label><input id="slider-elbow-y" type="range" min="-1" max="1" step="0.01" value="0"></div>
        <div><label>ELBOW_P</label><input id="slider-elbow-p" type="range" min="-1" max="1" step="0.01" value="0"></div>
        <div><label>WRIST_Y</label><input id="slider-wrist-y" type="range" min="-1" max="1" step="0.01" value="0"></div>
        <div><label>WRIST_P</label><input id="slider-wrist-p" type="range" min="-1" max="1" step="0.01" value="0"></div>
        <div><label>GRIPPER0</label><input id="slider-gripper0" type="range" min="-1" max="1" step="0.01" value="0"></div>
        <div><label>GRIPPER1</label><input id="slider-gripper1" type="range" min="-1" max="1" step="0.01" value="0"></div>
      </div>
      
    <div class="footer" id="joy_zone"> </div>
  </section>
  <!-- https://github.com/yoannmoinet/nipplejs -->
  <script src="nipplejs.js"></script>
  <script>
    let select = document.getElementById('img-select');
    select.onchange = event => {
        if (select.value == "base") {
            ros_base_img_subscribe();
        } else if (select.value == "arm") {
            ros_arm_img_subscribe();
        } else if (select.value == "hand") {
            ros_hand_img_subscribe();
        }
    }
    /// Virtual JOY ///
    const half_width = window.innerWidth / 2;
    console.log('half_width: ' + half_width);
    var current_right = -1;
    var current_left  = -1;
    var cur_x_left = 0.0;
    var cur_y_left = 0.0;
    var cur_x_right = 0.0;
    var cur_y_right = 0.0;
    var joystick = nipplejs.create({
        zone: document.getElementById('joy_zone'),
        size: 160,
        mode: 'dynamic',
        multitouch: true,
        color: 'blue'
    });
    function publishJoy(on_) {
        var frame_str = "webjoy"
        var axes = [0.0, 0.0,  0.0, 0.0]; // 4 x:1, y:0, yaw:2
        var btn  = [0, 0, 0,  0, 0, 0];   // 6 ebl: 4, turbo: 5
        if (on_) {
            btn[4] = 1;
        }
        axes[0] = cur_x_left;
        axes[1] = -cur_y_left;
        axes[2] = cur_x_right;
        var msg = new ROSLIB.Message({
            header: { frame_id: frame_str },
            axes: axes,
            buttons: btn
        });
        joytopic.publish(msg);
    }
    joystick.on('added', function(evt, data) {
        console.log('added');
        //if ( data.position.x > half_width ) {
        //} else {
        //}
    }).on('start', function(evt, data) {
        //console.log(data);
        //console.log(evt);
        console.log('start ' + data.id + ' / ' + data.identifier + ' | (' + data.position.x + ', ' + data.position.y + ')');
        if ( data.position.x > half_width ) {
            current_right = data.identifier;
            console.log('start right: ' + data.identifier);
        } else {
            current_left  = data.identifier;
            console.log('start left: ' + data.identifier);
        }
    }).on('end', function(evt, data) {
        console.log(evt);
        console.log(data);
        console.log('end ' + data.id + ' / ' + data.identifier);
        if ( data.identifier == current_right ) {
            current_right = -1;
            console.log('end right: ' + data.identifier);
            cur_x_right = 0.0;
            cur_y_right = 0.0;
            publishJoy(false);
        } else if ( data.identifier == current_left ) {
            current_left  = -1;
            console.log('end left: ' + data.identifier);
            // publish stop
            cur_x_left = 0.0;
            cur_y_left = 0.0;
            publishJoy(false);
        }
    }).on('move', function(evt, data) {
        if ( data.identifier == current_right ) {
            console.log ('right [' + data.identifier + '] (' + data.vector.x + ', ' + data.vector.y + ')');
            cur_x_right = data.vector.x;
            cur_y_right = data.vector.y;
            publishJoy(true);
        } else if ( data.identifier == current_left ) {
            console.log ('left [' + data.identifier + '] (' + data.vector.x + ', ' + data.vector.y + ')');
            cur_x_left = data.vector.x;
            cur_y_left = data.vector.y;
            publishJoy(true);
        } else {
            console.log ('warn: move [' + data.identifier + '] (' + data.vector.x + ', ' + data.vector.y + ')');
            ////
        }
    });
  </script>

<script>
  // 関節名とスライダーのID（9軸）
  const jointSliderIDs = [
  "slider-base-y",  // 0 => BASE_Y
  "slider-base-p",  // 1 => BASE_P
  "slider-base-r",  // 2 => BASE_R
  "slider-elbow-y", // 3 => ELBOW_Y
  "slider-elbow-p", // 4 => ELBOW_P
  "slider-wrist-y", // 5 => WRIST_Y
  "slider-wrist-p", // 6 => WRIST_P
  "slider-gripper0",// 7 => GRIPPER0
  "slider-gripper1" // 8 => GRIPPER1
  ];


  const angleMax = 1.57;

  const armPublisher = new ROSLIB.Topic({
    ros: ros,
    name: "/arm_controller/input",  
    messageType: "std_msgs/Float64MultiArray"
  });

  function publishFullState() {
    const angles = jointSliderIDs.map(id => {
      const slider = document.getElementById(id);
      // スライダーがなかったら0.0を代入
      return slider ? parseFloat(slider.value) * angleMax : 0.0;
    });

    // デバッグ出力（必要に応じて削除OK）
    if (angles.length !== 9) {
      console.warn(`⚠️ Warning: 送信軸数が9ではありません → ${angles.length}軸`);
    }

    const msg = new ROSLIB.Message({ data: angles });
    armPublisher.publish(msg);
    console.log(`[Sliders] Published: ${angles.map(a => a.toFixed(2)).join(", ")}`);
  }

  function setupSliders() {
  jointSliderIDs.forEach(id => {
    const slider = document.getElementById(id);
    if (slider) {
      slider.addEventListener("input", publishFullState);
      slider.addEventListener("change", publishFullState);  // ←これを追加
    }
  });
}





  window.addEventListener("load", () => {
  setupSliders();
  publishFullState(); // ← ページ読み込み時に一度9軸分の初期値を送信
  });
</script>



  
</body>
</html>